<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Dashboard Bot – Demo</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121b2a; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#60a5fa; --good:#34d399; --warn:#fbbf24; --bad:#fb7185;
      --border:rgba(148,163,184,.18); --shadow:0 14px 35px rgba(0,0,0,.45); --radius:18px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(52,211,153,.14), transparent 55%),
        radial-gradient(900px 500px at 50% 100%, rgba(251,191,36,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:28px 18px 44px}
    .top{display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,rgba(96,165,250,.9),rgba(52,211,153,.85));box-shadow:0 10px 30px rgba(96,165,250,.18)}
    h1{margin:0;font-size:20px}
    .sub{margin:3px 0 0;color:var(--muted);font-size:13px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(148,163,184,.10);border:1px solid var(--border);color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--good)} .dot.bad{background:var(--bad)}
    .grid{display:grid;gap:16px;grid-template-columns:1.15fr .85fr;align-items:start}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,rgba(18,27,42,.92),rgba(15,22,35,.92));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .cardHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--border)}
    .cardTitle{font-weight:700;font-size:14px}
    .cardBody{padding:16px}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    textarea,input,select{width:100%;background:rgba(2,6,23,.55);color:var(--text);border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:12px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 160px}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid rgba(148,163,184,.22);background:rgba(148,163,184,.10);color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:600}
    button:hover{background:rgba(148,163,184,.16)}
    .primary{background:linear-gradient(135deg,rgba(96,165,250,.95),rgba(59,130,246,.75));border-color:rgba(96,165,250,.45)}
    .green{background:linear-gradient(135deg,rgba(52,211,153,.95),rgba(16,185,129,.75));border-color:rgba(52,211,153,.35)}
    .ghost{background:transparent}
    .small{padding:8px 10px;font-size:12px;border-radius:12px}
    .mono{font-family:var(--mono)}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;color:var(--muted);font-size:12px}
    .kv{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;background:rgba(148,163,184,.08);border:1px solid var(--border)}

    .out{border:1px solid rgba(148,163,184,.20);background:rgba(2,6,23,.55);border-radius:16px;overflow:hidden;margin-top:12px}
    .outHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(148,163,184,.18);background:rgba(255,255,255,.02)}
    .badge{font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);color:var(--muted);display:inline-flex;align-items:center;gap:8px}
    .badge.ok{border-color:rgba(52,211,153,.35);color:rgba(167,243,208,.95)}
    .badge.bad{border-color:rgba(251,113,133,.40);color:rgba(254,202,202,.98)}
    .badge.warn{border-color:rgba(251,191,36,.35);color:rgba(253,230,138,.98)}
    .json{padding:12px;margin:0;white-space:pre-wrap;word-break:break-word;font-family:var(--mono);font-size:12px;line-height:1.35}
    .md{padding:12px 14px;line-height:1.5}
    .md ul{margin:8px 0 0 20px}
    .md li{margin:6px 0}

    /* History */
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(148,163,184,.14);vertical-align:top}
    th{color:rgba(148,163,184,.95);font-weight:700;text-align:left}
    tr:hover td{background:rgba(148,163,184,.06)}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);color:var(--muted);font-size:11px}
    .tag.ask{border-color:rgba(96,165,250,.35);color:rgba(191,219,254,.95)}
    .tag.workflow{border-color:rgba(52,211,153,.35);color:rgba(167,243,208,.95)}
    .tag.err{border-color:rgba(251,113,133,.40);color:rgba(254,202,202,.98)}
    .click{cursor:pointer}

    /* Drawer */
    .drawer{position:fixed; inset:0; display:none; background:rgba(0,0,0,.55); align-items:flex-end; justify-content:center; padding:18px}
    .drawer.show{display:flex}
    .drawerPanel{width:min(980px,100%); max-height:80vh; overflow:auto; background:linear-gradient(180deg,rgba(18,27,42,.98),rgba(15,22,35,.98)); border:1px solid rgba(148,163,184,.22); border-radius:20px; box-shadow:0 30px 80px rgba(0,0,0,.65)}
    .drawerHead{position:sticky; top:0; display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid rgba(148,163,184,.18); background:rgba(5,10,18,.85); backdrop-filter: blur(6px)}
    .drawerGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:12px}
    @media (max-width:900px){.drawerGrid{grid-template-columns:1fr}}

    .toast{position:fixed;right:18px;bottom:18px;padding:10px 12px;border-radius:14px;background:rgba(15,22,35,.92);border:1px solid rgba(148,163,184,.22);box-shadow:0 18px 40px rgba(0,0,0,.55);font-size:12px;opacity:0;transform:translateY(8px);transition:opacity .18s ease,transform .18s ease;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
    .spinner{width:14px;height:14px;border-radius:50%;border:2px solid rgba(229,231,235,.25);border-top-color:rgba(229,231,235,.95);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>AI Dashboard Bot <span class="mono" style="opacity:.75">/ demo</span></h1>
          <div class="sub">AI API + automation workflow + persisted history (audit trail).</div>
        </div>
      </div>
      <div class="pillrow">
        <div class="pill"><span class="dot" id="apiDot"></span><span id="apiStatus">Checking API…</span></div>
        <div class="pill"><span class="dot ok"></span>Local API: <span class="mono">127.0.0.1:5000</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">Ask AI</div>
          <div class="badge warn" id="askBadge"><span class="dot"></span><span>Idle</span></div>
        </div>
        <div class="cardBody">
          <label for="q">Prompt</label>
          <textarea id="q">Give me 3 bullet points describing what this demo proves to an employer hiring for AI/automation roles.</textarea>

          <div class="btnbar">
            <button class="primary" onclick="askAI()">Send</button>
            <button class="ghost" onclick="setExample('employer')">Employer proof</button>
            <button class="ghost" onclick="setExample('api')">API design</button>
            <button class="ghost" onclick="setExample('safety')">Safety/cost</button>
            <button class="ghost" onclick="clearOut('ask')">Clear</button>
          </div>

          <div class="meta">
            <div class="kv">Latency: <span class="mono" id="askMs">—</span></div>
            <div class="kv">Request ID: <span class="mono" id="askReq">—</span></div>
            <button class="small" onclick="copyText('askJson')">Copy JSON</button>
            <button class="small" onclick="toggleView('ask')">Toggle JSON/Pretty</button>
          </div>

          <div class="out">
            <div class="outHead">
              <div class="mono" style="font-size:12px; opacity:.9">Response</div>
              <div class="badge" id="askHttp">HTTP —</div>
            </div>
            <div id="askPretty" class="md"></div>
            <pre id="askJson" class="json" style="display:none"></pre>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">Automation Workflow</div>
          <div class="badge warn" id="wfBadge"><span class="dot"></span><span>Idle</span></div>
        </div>

        <div class="cardBody">
          <div class="row">
            <div><label>User</label><input id="wfUser" value="demo_user"/></div>
            <div><label>Amount</label><input id="wfAmount" type="number" value="12000"/></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Explain with AI</label>
              <select id="wfExplain">
                <option value="true" selected>true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div>
              <label>Quick amounts</label>
              <div class="btnbar" style="margin-top:0">
                <button class="small" onclick="setAmount(5000)">5,000</button>
                <button class="small" onclick="setAmount(12000)">12,000</button>
                <button class="small" onclick="setAmount(25000)">25,000</button>
              </div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:10px">
            <button class="green" onclick="runWorkflow()">Run workflow</button>
            <button class="ghost" onclick="clearOut('wf')">Clear</button>
            <button class="ghost" onclick="toggleView('wf')">Toggle JSON/Pretty</button>
          </div>

          <div class="meta">
            <div class="kv">Latency: <span class="mono" id="wfMs">—</span></div>
            <div class="kv">Request ID: <span class="mono" id="wfReq">—</span></div>
            <button class="small" onclick="copyText('wfJson')">Copy JSON</button>
          </div>

          <div class="out">
            <div class="outHead">
              <div class="mono" style="font-size:12px; opacity:.9">Result</div>
              <div class="badge" id="wfHttp">HTTP —</div>
            </div>
            <div id="wfPretty" class="md"></div>
            <pre id="wfJson" class="json" style="display:none"></pre>
          </div>

          <!-- HISTORY -->
          <div class="out">
            <div class="outHead">
              <div class="mono" style="font-size:12px; opacity:.9">History</div>
              <div style="display:flex; gap:8px; align-items:center">
                <select id="histFilter" style="padding:8px 10px; border-radius:12px" onchange="refreshHistory()">
                  <option value="all" selected>All</option>
                  <option value="ask">Ask</option>
                  <option value="workflow">Workflow</option>
                </select>
                <button class="small" onclick="exportHistory()">Export</button>
                <button class="small" onclick="clearHistory()">Clear</button>
                <button class="small" onclick="refreshHistory()">Refresh</button>
              </div>
            </div>
            <div class="md" id="histTable">Loading…</div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawer" id="drawer" onclick="closeDrawer(event)">
    <div class="drawerPanel" onclick="event.stopPropagation()">
      <div class="drawerHead">
        <div class="mono" id="drawerTitle">Details</div>
        <div style="display:flex; gap:8px">
          <button class="small" onclick="copyDrawer()">Copy</button>
          <button class="small" onclick="closeDrawer()">Close</button>
        </div>
      </div>
      <div class="drawerGrid">
        <div class="out">
          <div class="outHead"><div class="mono" style="font-size:12px;opacity:.9">Input</div></div>
          <pre id="drawerInput" class="json"></pre>
        </div>
        <div class="out">
          <div class="outHead"><div class="mono" style="font-size:12px;opacity:.9">Output</div></div>
          <pre id="drawerOutput" class="json"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const API_BASE_URL =
    window.location.hostname === "localhost"
      ? "http://127.0.0.1:5000"
      : window.location.origin;
const API = "API_BASE_URL";
let HISTORY_CACHE = [];

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> el.classList.remove("show"), 1500);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function setBadge(id, state, text){
  const el = document.getElementById(id);
  const dot = el.querySelector(".dot") || el.querySelector("span.dot");
  el.classList.remove("ok","bad","warn");
  if(state==="ok"){ el.classList.add("ok"); dot.className="dot ok"; }
  else if(state==="bad"){ el.classList.add("bad"); dot.className="dot bad"; }
  else { el.classList.add("warn"); dot.className="dot"; }
  el.querySelector("span:last-child").textContent = text;
}

function setHttp(id, ok, status){
  const el = document.getElementById(id);
  el.classList.remove("ok","bad","warn");
  el.classList.add(ok ? "ok" : "bad");
  el.textContent = "HTTP " + status;
}

function prettyBullets(text){
  if(!text) return "";
  const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
  const items = lines.map(l => l.replace(/^\d+\.\s*/,"").replace(/^\-\s*/,"")).filter(l => l.length > 0);
  if(items.length <= 1){
    return "<div>" + escapeHtml(text).replace(/\n/g,"<br/>") + "</div>";
  }
  return "<ul>" + items.map(i=>"<li>"+escapeHtml(i)+"</li>").join("") + "</ul>";
}

function toggleView(prefix){
  const pretty = document.getElementById(prefix+"Pretty");
  const json = document.getElementById(prefix+"Json");
  const showingJson = json.style.display !== "none";
  json.style.display = showingJson ? "none" : "block";
  pretty.style.display = showingJson ? "block" : "none";
}

function clearOut(prefix){
  document.getElementById(prefix+"Pretty").innerHTML = "";
  document.getElementById(prefix+"Json").textContent = "";
  if(prefix==="ask"){
    document.getElementById("askMs").textContent = "—";
    document.getElementById("askReq").textContent = "—";
    document.getElementById("askHttp").textContent = "HTTP —";
    setBadge("askBadge","warn","Idle");
  } else {
    document.getElementById("wfMs").textContent = "—";
    document.getElementById("wfReq").textContent = "—";
    document.getElementById("wfHttp").textContent = "HTTP —";
    setBadge("wfBadge","warn","Idle");
  }
}

function setExample(which){
  const q = document.getElementById("q");
  if(which==="employer"){
    q.value = "Give me 3 bullet points describing what this demo proves to an employer hiring for AI/automation roles.";
  } else if(which==="api"){
    q.value = "Explain the architecture of this demo: API endpoints, request IDs, and why dashboard-ready JSON matters.";
  } else if(which==="safety"){
    q.value = "List practical safety/cost guardrails you would add to an AI API in production (rate limiting, input size, retries, etc.)";
  }
  toast("Prompt loaded");
}

function setAmount(v){ document.getElementById("wfAmount").value = v; toast("Amount set to " + v); }

async function apiHealth(){
  try{
    const t0 = performance.now();
    const res = await fetch(API + "/health");
    const ms = Math.round(performance.now()-t0);
    if(res.ok){
      document.getElementById("apiDot").className = "dot ok";
      document.getElementById("apiStatus").textContent = "API online ("+ms+" ms)";
    } else {
      document.getElementById("apiDot").className = "dot bad";
      document.getElementById("apiStatus").textContent = "API error ("+res.status+")";
    }
  } catch(e){
    document.getElementById("apiDot").className = "dot bad";
    document.getElementById("apiStatus").textContent = "API offline";
  }
}

async function askAI(){
  setBadge("askBadge","warn","Running…");
  const t0 = performance.now();
  const question = document.getElementById("q").value;

  try{
    const res = await fetch(API + "/api/ask", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ question })
    });
    const ms = Math.round(performance.now()-t0);
    document.getElementById("askMs").textContent = ms + " ms";
    setHttp("askHttp", res.ok, res.status);

    const body = await res.json().catch(()=> ({}));
    document.getElementById("askReq").textContent = body.request_id || "—";

    document.getElementById("askJson").textContent = JSON.stringify(body, null, 2);
    document.getElementById("askPretty").innerHTML = prettyBullets(body.answer || (body.error ? ("Error: " + body.error) : "No response"));
    setBadge("askBadge", res.ok ? "ok":"bad", res.ok ? "Success" : "Error");
    toast(res.ok ? "AI response received" : "Request failed");
    refreshHistory();
  } catch(e){
    setBadge("askBadge","bad","Network error");
    document.getElementById("askPretty").innerHTML = "<div>Network error: " + escapeHtml(e.message) + "</div>";
    toast("API not reachable");
  }
}

async function runWorkflow(){
  setBadge("wfBadge","warn","Running…");
  const t0 = performance.now();
  const user = document.getElementById("wfUser").value || "unknown";
  const amount = Number(document.getElementById("wfAmount").value || 0);
  const explain_with_ai = document.getElementById("wfExplain").value === "true";

  try{
    const res = await fetch(API + "/api/workflow/demo", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user, amount, explain_with_ai })
    });
    const ms = Math.round(performance.now()-t0);
    document.getElementById("wfMs").textContent = ms + " ms";
    setHttp("wfHttp", res.ok, res.status);

    const body = await res.json().catch(()=> ({}));
    document.getElementById("wfReq").textContent = body.request_id || "—";

    document.getElementById("wfJson").textContent = JSON.stringify(body, null, 2);
    const pretty =
      "<div><b>Decision</b>: <span class='mono'>" + escapeHtml(body.decision || "—") + "</span></div>" +
      "<div><b>Risk</b>: <span class='mono'>" + escapeHtml(body.risk || "—") + "</span></div>" +
      "<div><b>Amount</b>: <span class='mono'>" + escapeHtml(body.amount ?? "—") + "</span></div>" +
      (body.ai_summary ? "<div style='margin-top:10px'><b>AI summary</b>:</div>" + prettyBullets(body.ai_summary) : "");

    document.getElementById("wfPretty").innerHTML = pretty;
    setBadge("wfBadge", res.ok ? "ok":"bad", res.ok ? "Success" : "Error");
    toast(res.ok ? "Workflow complete" : "Workflow failed");
    refreshHistory();
  } catch(e){
    setBadge("wfBadge","bad","Network error");
    document.getElementById("wfPretty").innerHTML = "<div>Network error: " + escapeHtml(e.message) + "</div>";
    toast("API not reachable");
  }
}

async function refreshHistory(){
  const el = document.getElementById("histTable");
  const filter = document.getElementById("histFilter").value;
  try{
    const res = await fetch(API + "/api/history?limit=50");
    const body = await res.json();
    let items = body.items || [];
    HISTORY_CACHE = items;

    if(filter === "ask"){
      items = items.filter(it => String(it.kind||"").startsWith("ask"));
    } else if(filter === "workflow"){
      items = items.filter(it => String(it.kind||"") === "workflow");
    }

    if(items.length === 0){
      el.innerHTML = "<div>No history yet. Run Ask AI or Workflow.</div>";
      return;
    }

    const rows = items.map(it => {
      const kind = String(it.kind||"");
      const tagClass = kind === "workflow" ? "workflow" : (kind.startsWith("ask") ? "ask" : "err");
      const summary =
        kind === "workflow"
          ? ("Decision: <span class='mono'>"+escapeHtml(it.output?.decision||"—")+"</span> / Risk: <span class='mono'>"+escapeHtml(it.output?.risk||"—")+"</span> / $"+escapeHtml(it.output?.amount ?? "—"))
          : ("Q: " + escapeHtml(String(it.input?.question||"").slice(0,70)));

      return `
        <tr class="click" onclick="openDrawer(${it.id})">
          <td class="mono">${escapeHtml(it.ts)}</td>
          <td><span class="tag ${tagClass}">${escapeHtml(kind)}</span></td>
          <td class="mono">${escapeHtml(String(it.latency_ms ?? "—"))}</td>
          <td class="mono">${escapeHtml(String(it.request_id||"").slice(0,8))}</td>
          <td>${summary}</td>
        </tr>`;
    }).join("");

    el.innerHTML = `
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Time</th><th>Kind</th><th>ms</th><th>Req</th><th>Summary</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  } catch(e){
    el.innerHTML = "<div>History error: " + escapeHtml(e.message) + "</div>";
  }
}

async function clearHistory(){
  try{
    await fetch(API + "/api/history/clear", { method:"POST" });
    toast("History cleared");
    refreshHistory();
  } catch(e){
    toast("Clear failed");
  }
}

function openDrawer(id){
  const item = HISTORY_CACHE.find(x => x.id === id);
  if(!item){ toast("Not found"); return; }
  document.getElementById("drawerTitle").textContent = `Details #${id} • ${item.kind} • ${item.ts}`;
  document.getElementById("drawerInput").textContent = JSON.stringify(item.input, null, 2);
  document.getElementById("drawerOutput").textContent = JSON.stringify(item.output, null, 2);
  document.getElementById("drawer").classList.add("show");
}
function closeDrawer(){
  document.getElementById("drawer").classList.remove("show");
}
function copyDrawer(){
  const t = document.getElementById("drawerInput").textContent + "\n\n---\n\n" + document.getElementById("drawerOutput").textContent;
  navigator.clipboard.writeText(t);
  toast("Copied details");
}

function exportHistory(){
  const blob = new Blob([JSON.stringify({items:HISTORY_CACHE}, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ai-dashboard-history.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("Exported JSON");
}

function copyText(id){
  const txt = document.getElementById(id).textContent || "";
  navigator.clipboard.writeText(txt);
  toast("Copied");
}

apiHealth();
refreshHistory();
setInterval(apiHealth, 5000);
setInterval(refreshHistory, 7000);
</script>
</body>
</html>

